<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
        <title>Nearby PLUTO lots</title>
        <style>
            body {
                background-color: aquamarine;
            }
        </style>
        <!-- <script>
            function autoRefresh(t) {
                setTimeout("location.reload(true);", t);
            }
        </script> -->
    </head>
    <body> <!-- onload = "JavaScript:autoRefresh(20000);" --> 
        <!-- <button id = "find-me">Show my location</button><br/> -->
        <p id = "status"></p>
        <!-- <a id = "map-link" target="_blank"></a> -->

        <!--SCRIPT FOR THREE.js MODULE-->
    <script type="module">
        import * as THREE from 'https://unpkg.com/three/build/three.module.js';
		import { ARButton } from 'https://unpkg.com/three/examples/jsm/webxr/ARButton.js';

        // import { test } from './my-location.js';
        // declare container, camera, scene, renderer
        var container;
        var camera, scene, raycaster, renderer;

        var INTERSECTED;
        var objects = [];

        const pointer = new THREE.Vector2();

        // declare epsg
        const epsg_sm = 'EPSG:3857'

        //determine user geolocation:
        var options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };
        
        function success(pos) {
            var crd = pos.coords;
            // console.log(crd);
            var long = crd.longitude;
            var lat = crd.latitude;
            var coords = [long, lat]
            var sm_crds = proj4(epsg_sm, coords);
            // fetch request to query postgres db for PLUTO tax lots within 50 meters of user's current location
            fetch(`https://powerful-woodland-32319.herokuapp.com/db?long=${long}&lat=${lat}`)
                .then(response => response.json())
                .then(json => {
                    console.log(json);
                    init(sm_crds, json);
                    animate();
                })
        }
        
        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }
        
        navigator.geolocation.getCurrentPosition(success, error, [options]);

        // three.js init(), onWindowResize, animate, render functions
        function init(sm_crds, json) {
                // console.log(sm_crds);
                container = document.createElement( 'div' );
                document.body.appendChild( container );

                scene = new THREE.Scene();
                const group = new THREE.Group();

                camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.01, 100 );
                // camera.position.set = ( 0, 0, 5);

                var light = new THREE.HemisphereLight( 0xffffff, 0xbbbbff, 1 );
                light.position.set( 0.5, 1, 0.25 );
                scene.add( light );

                //
                raycaster = new THREE.Raycaster();

                renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                renderer.xr.enabled = true;
                container.appendChild( renderer.domElement );

                //
                document.addEventListener( 'touchend', onPointerMove );

                document.body.appendChild( ARButton.createButton( renderer, {color: 0x98fb98 } ) );

                //

                var geometry = new THREE.BoxGeometry( 0.5, 0.5, 0.5 );
                var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
                var user_location = new THREE.Mesh( geometry, material );
                user_location.position.set( sm_crds[0]-sm_crds[0], 0, sm_crds[1]-sm_crds[1] );
                scene.add(user_location);

                // add nearby PLUTO lot points to scene
                for(const each of json){
                    var plutoMaterial = new THREE.MeshBasicMaterial( { color: 0xfd5602 } );
                    var pluto_location = new THREE.Mesh( geometry, plutoMaterial );
                    pluto_location.position.set(each.st_x-sm_crds[0], 0, sm_crds[1]-each.st_y);
                    // group.add(pluto_location);
                    scene.add( pluto_location );
                    objects.push( pluto_location );
                }

                // scene.add( group );

                //

                window.addEventListener( 'resize', onWindowResize, false );

            }

            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );

            }

            function onPointerMove( event ) {

                pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                pointer.y = -(event.clientY / window.innerHeight ) * 2 + 1;

            }

            function animate() {

                renderer.setAnimationLoop( render );

            }

            function render() {

                // find intersections of touch events and pluto locations

                raycaster.setFromCamera( pointer, camera );

                const intersects = raycaster.intersectObjects( objects, false );
                if ( intersects.length > 0 ){
                    if ( INTERSECTED != intersects[0].object ){
                        if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );

                        INTERSECTED = intersects[0].object;
                        INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
                        INTERSECTED.material.emissive.setHex( 0x7fffd4 );
                    }
                } else {
                    if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
                    INTERSECTED = null;
                }

                renderer.render( scene, camera );

            }
    </script>    
    </body>
    <!-- <script src="/js/my-location.js"></script> -->
</html>